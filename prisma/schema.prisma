// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")

  relationMode = "prisma"
}

// model Content {
//   id              String          @id @default(cuid())
//   nonce           Bytes           @db.ByteA
//   content         Bytes           @db.ByteA
// }

model Mail {
  id              String          @id @default(cuid())
  inbound         Boolean
  from            String
  to              String
  cc              String
  bcc             String
  at              DateTime
  recvDelay       Int
  messageId       String?         @db.VarChar(995)
  subject         String?
  html            String?         @db.LongText

  inReplyTo       String?         @db.VarChar(995)

  convoId         String
  convo           Convo           @relation(fields: [convoId], references: [id])

  @@index([convoId])
}

model Convo {
  id              String          @id @default(cuid())
  subject         String?
  interlocutors   String
  mails           Mail[]

  latest          DateTime

  folderId        String 
  folder          Folder          @relation(fields: [folderId], references: [id])

  @@index([folderId])
}

enum FolderTypes {
  Inbox
  Sent
  Drafts
  Spam
  Deleted
  Other
}

model Folder {
  id              String          @id @default(cuid())
  name            String
  type            FolderTypes

  addressId       String
  address         Address         @relation(fields: [addressId], references: [id])

  convos          Convo[]

  @@unique([name, type, addressId])
  @@index([addressId])
}

model Address {
  id              String          @id @default(cuid())
  name            String          @db.VarChar(320) @unique
  catchAll        Boolean

  folders         Folder[]

  subdomainId     String
  subdomain       Subdomain       @relation(fields: [subdomainId], references: [id])
  usersLink       UsersOnAddressesLink[]

  @@index([subdomainId])
}

model UsersOnAddressesLink {
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  addressId       String
  address         Address         @relation(fields: [addressId], references: [id])

  consult         Boolean?
  view            Boolean?
  compose         Boolean?
  send            Boolean?
  delete          Boolean?

  mute            Boolean?

  @@id([userId, addressId])
  @@index([userId])
  @@index([addressId])
}

model Subdomain {
  id              String          @id @default(cuid())
  name            String          @db.VarChar(249) @unique

  domainId        String
  domain          Domain          @relation(fields: [domainId], references: [id])
  usersLink       UsersOnSubdomainsLink[]

  addresses       Address[]

  @@index([domainId])
}

model UsersOnSubdomainsLink {
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  subdomainId     String
  subdomain       Subdomain       @relation(fields: [subdomainId], references: [id])

  consult         Boolean?
  view            Boolean?
  compose         Boolean?
  createMail      Boolean?
  send            Boolean?
  delete          Boolean?

  mute            Boolean?

  @@id([userId, subdomainId])
  @@index([userId])
  @@index([subdomainId])
}

model Domain {
  id              String          @id @default(cuid())
  name            String          @db.VarChar(253) @unique
  privDkim        String

  usersLink       UsersOnDomainsLink[]

  subdomains      Subdomain[]
}

model UsersOnDomainsLink {
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  domainId        String
  domain          Domain          @relation(fields: [domainId], references: [id])

  consult         Boolean?
  view            Boolean?
  compose         Boolean?
  createMail      Boolean?
  createSub       Boolean?
  send            Boolean?
  delete          Boolean?

  mute            Boolean?

  @@id([userId, domainId])
  @@index([userId])
  @@index([domainId])
}

model User {
  id              String          @id @default(cuid())
  username        String          @db.VarChar(255) @unique
  webPushSubData  String          @db.LongText
  passwordHash    String
  lastPwChange    DateTime

  domainsLink     UsersOnDomainsLink[]
  subdomainsLink  UsersOnSubdomainsLink[]
  addressesLink   UsersOnAddressesLink[]
}
